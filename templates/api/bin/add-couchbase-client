#!/usr/bin/env bash
# Add the couchbase-client library as an editable dependency

set -e

# Change to the api directory
cd "$(dirname "$0")/.."

# Detect OS for sed compatibility
if [[ "$OSTYPE" == "darwin"* ]]; then
    SED_INPLACE=(sed -i '')
else
    SED_INPLACE=(sed -i)
fi

echo "📦 Adding couchbase-client library as editable dependency..."

$(dirname "$0")/uv add --editable ../lib/py/couchbase-client

# config with env vars
# init and deinit client

echo "✅ Couchbase client library added successfully!"

# Add Couchbase environment variables to polytope.yml if they don't exist
echo ""
echo "📝 Adding Couchbase environment variables to polytope.yml..."

# Check if COUCHBASE_HOST already exists in the env section
if ! grep -q "COUCHBASE_HOST" polytope.yml; then
    # Find the line with "env:" and add Couchbase env vars after the last env var
    # We'll insert after TEMPORAL_TASK_QUEUE or the last env var we find
    if grep -q "TEMPORAL_TASK_QUEUE" polytope.yml; then
        "${SED_INPLACE[@]}" "/TEMPORAL_TASK_QUEUE/a\\
\\
            - { name: COUCHBASE_HOST, value: couchbase }\\
            - { name: COUCHBASE_USERNAME, value: user }\\
            - { name: COUCHBASE_PASSWORD, value: password }\\
            - { name: COUCHBASE_BUCKET, value: default }\\
            - { name: COUCHBASE_PROTOCOL, value: couchbase }
" polytope.yml
    else
        # If TEMPORAL_TASK_QUEUE doesn't exist, add after LOG_LEVEL or another env var
        "${SED_INPLACE[@]}" "/LOG_LEVEL/a\\
\\
            - { name: COUCHBASE_HOST, value: couchbase }\\
            - { name: COUCHBASE_USERNAME, value: user }\\
            - { name: COUCHBASE_PASSWORD, value: password }\\
            - { name: COUCHBASE_BUCKET, value: default }\\
            - { name: COUCHBASE_PROTOCOL, value: couchbase }
" polytope.yml
    fi
    echo "✅ Added Couchbase environment variables to polytope.yml"
else
    echo "ℹ️  Couchbase environment variables already exist in polytope.yml"
fi

# Add the add-couchbase-collection tool to polytope.yml if it doesn't already exist
if ! grep -q "{{ project-name }}-add-couchbase-collection:" polytope.yml; then
    echo ""
    echo "📝 Adding add-couchbase-collection tool to polytope.yml..."
    
    cat >> polytope.yml << 'EOF'

  {{ project-name }}-add-couchbase-collection:
    info: Scaffold a new Python script and add it to pyproject.toml. Run this to create test scripts for your agents!
    params:
      - id: name
        info: Scaffolds a new Couchbase collection with CRUD operations, Pydantic models, and automatic integration.
        type: str
    run:
      - tool: {{ project-name }}
        args:
          id: {{ project-name }}-add-couchbase-collection
          restart-policy: never
          cmd: ./bin/add-couchbase-collection {pt.param name}
          create: always
EOF
    
    echo "✅ Added add-couchbase-collection tool to polytope.yml"
fi

# Create the Couchbase configuration file
echo ""
echo "📝 Creating Couchbase configuration file..."

# Create the couchbase.py configuration file
cat > src/backend/conf/couchbase.py << 'EOF'
from pydantic import BaseModel

from ..utils import auth, env, log
from ..utils.env import EnvVarSpec

from couchbase_client import CouchbaseConf

#### Env Vars ####

COUCHBASE_HOST = EnvVarSpec(
    id="COUCHBASE_HOST",
    default="couchbase"
)

COUCHBASE_USERNAME = EnvVarSpec(
    id="COUCHBASE_USERNAME",
    default="user"
)

COUCHBASE_PASSWORD = EnvVarSpec(
    id="COUCHBASE_PASSWORD",
    default="password",
    is_secret=True
)

COUCHBASE_BUCKET = EnvVarSpec(
    id="COUCHBASE_BUCKET",
    default="main"
)

COUCHBASE_PROTOCOL = EnvVarSpec(
    id="COUCHBASE_PROTOCOL",
    default="couchbase"
)

VALIDATED_ENV_VARS = [
    COUCHBASE_HOST,
    COUCHBASE_USERNAME,
    COUCHBASE_PASSWORD,
    COUCHBASE_BUCKET,
    COUCHBASE_PROTOCOL
]


#### Getters ####

def get_couchbase_conf():
    """Get Couchbase connection configuration."""
    return CouchbaseConf(
        host=env.parse(COUCHBASE_HOST),
        username=env.parse(COUCHBASE_USERNAME),
        password=env.parse(COUCHBASE_PASSWORD),
        bucket=env.parse(COUCHBASE_BUCKET),
        protocol=env.parse(COUCHBASE_PROTOCOL),
    )
EOF

echo "✅ Created src/backend/conf/couchbase.py"

# Create the init directory if it doesn't exist
mkdir -p src/backend/init

# Create the __init__.py file for the init module if it doesn't exist
if [ ! -f src/backend/init/__init__.py ]; then
    touch src/backend/init/__init__.py
    echo "✅ Created src/backend/init/__init__.py"
fi

# Create the couchbase init file
echo ""
echo "📝 Creating Couchbase initialization file..."

cat > src/backend/init/couchbase.py << 'EOF'
from fastapi import FastAPI

from couchbase_client import CouchbaseClient

from ..conf.couchbase import get_couchbase_conf
from ..utils.log import get_logger

logger = get_logger(__name__)

async def init(app: FastAPI):
    """Initialize Couchbase client and collections."""
    logger.info("Initializing Couchbase client...")
    couchbase_config = get_couchbase_conf()
    app.state.couchbase_client = CouchbaseClient(couchbase_config)
    await app.state.couchbase_client.init_connection()
    logger.info("Couchbase client connected successfully")

    # Initialize collections if they exist
    try:
        from ..couchbase.collections import COLLECTIONS
        logger.info(f"Initializing {len(COLLECTIONS)} Couchbase collection(s)...")
        for Collection in COLLECTIONS:
            await Collection(app.state.couchbase_client).initialize()
        logger.info("All Couchbase collections initialized successfully")
    except ImportError:
        # No collections module yet, that's fine
        logger.info("No Couchbase collections found. You can add collections using the add-couchbase-collection tool.")

async def deinit(app: FastAPI):
    """Close Couchbase client connection."""
    logger.info("Closing Couchbase client connection...")
    await app.state.couchbase_client.close()
    logger.info("Couchbase client connection closed")
EOF

echo "✅ Created src/backend/init/couchbase.py"

# Update the main conf/__init__.py file to import couchbase configuration
echo ""
echo "📝 Updating src/backend/conf/__init__.py to include Couchbase configuration..."

# Add import at the top of the file (after the existing imports)
if ! grep -q "from . import couchbase" src/backend/conf/__init__.py; then
    # Add the import after the line with "from ..utils.env import EnvVarSpec"
    "${SED_INPLACE[@]}" '/from \.\.utils\.env import EnvVarSpec/a\
from . import couchbase
' src/backend/conf/__init__.py
    echo "✅ Added couchbase import to conf/__init__.py"
else
    echo "ℹ️  Couchbase import already exists in conf/__init__.py"
fi

# Add VALIDATED_ENV_VARS.extend(couchbase.VALIDATED_ENV_VARS) after the initial VALIDATED_ENV_VARS definition
if ! grep -q "VALIDATED_ENV_VARS.extend(couchbase.VALIDATED_ENV_VARS)" src/backend/conf/__init__.py; then
    # Find the closing bracket of VALIDATED_ENV_VARS and add the extend statement after it
    "${SED_INPLACE[@]}" '/^VALIDATED_ENV_VARS = \[/,/^\]/{
        /^\]/a\
\
VALIDATED_ENV_VARS.extend(couchbase.VALIDATED_ENV_VARS)
    }' src/backend/conf/__init__.py
    echo "✅ Added VALIDATED_ENV_VARS.extend(couchbase.VALIDATED_ENV_VARS) to conf/__init__.py"
else
    echo "ℹ️  VALIDATED_ENV_VARS extension already exists in conf/__init__.py"
fi

# Update main.py to use the init module
echo ""
echo "📝 Updating main.py to use the couchbase init module..."

# Check if the import already exists
if ! grep -q "from \.init import couchbase" src/backend/main.py; then
    # Add the import after the existing imports (after from . import conf)
    "${SED_INPLACE[@]}" '/from \. import conf/a\
from .init import couchbase
' src/backend/main.py
    echo "✅ Added couchbase init import to main.py"
else
    echo "ℹ️  Couchbase init import already exists in main.py"
fi

# Replace the inline couchbase initialization with the init module call
# First, check if the old pattern exists (inline initialization)
if grep -q "from \.clients\.couchbase import CouchbaseClient" src/backend/main.py; then
    echo "📝 Replacing inline Couchbase initialization with init module..."

    # Create a temporary file with the updated content
    awk '
    BEGIN { in_couchbase_block = 0; found_couchbase_if = 0 }

    # Detect the start of the Couchbase initialization block
    /if conf\.USE_COUCHBASE:/ {
        if (!found_couchbase_if) {
            found_couchbase_if = 1
            in_couchbase_block = 1
            print "    # Initialize Couchbase client if enabled"
            print "    if conf.USE_COUCHBASE:"
            print "        await couchbase.init(app)"
            print ""
            next
        }
    }

    # Skip lines in the Couchbase initialization block
    in_couchbase_block && /^[[:space:]]*from \.clients\.couchbase import CouchbaseClient/ { next }
    in_couchbase_block && /^[[:space:]]*couchbase_config = conf\.get_couchbase_conf\(\)/ { next }
    in_couchbase_block && /^[[:space:]]*app\.state\.couchbase_client = CouchbaseClient/ { next }
    in_couchbase_block && /^[[:space:]]*await app\.state\.couchbase_client\.init_connection\(\)/ { next }
    in_couchbase_block && /^[[:space:]]*$/ { next }
    in_couchbase_block && /^[[:space:]]*# Import and initialize all Couchbase collections/ { next }
    in_couchbase_block && /^[[:space:]]*from \.couchbase\.collections import COLLECTIONS/ { next }
    in_couchbase_block && /^[[:space:]]*for Collection in COLLECTIONS:/ { next }
    in_couchbase_block && /^[[:space:]]*await Collection\(app\.state\.couchbase_client\)\.initialize\(\)/ { next }

    # Detect the end of the Couchbase block (next if statement or empty line followed by non-indented content)
    in_couchbase_block && (/^[[:space:]]*# Initialize auth client if enabled/ || /^[[:space:]]*if / && !/if conf\.USE_COUCHBASE:/) {
        in_couchbase_block = 0
    }

    # Print all other lines
    !in_couchbase_block { print }
    ' src/backend/main.py > src/backend/main.py.tmp

    mv src/backend/main.py.tmp src/backend/main.py
    echo "✅ Replaced inline Couchbase initialization with init module"
fi

# Replace the inline couchbase cleanup with the deinit module call
if grep -q "await app\.state\.couchbase_client\.close\(\)" src/backend/main.py; then
    echo "📝 Replacing inline Couchbase cleanup with deinit module..."

    "${SED_INPLACE[@]}" 's/await app\.state\.couchbase_client\.close()/await couchbase.deinit(app)/' src/backend/main.py

    echo "✅ Replaced inline Couchbase cleanup with deinit module"
fi

echo ""
echo "✅ Couchbase client setup complete!"
echo ""
echo "You can now:"
echo "  1. Import and use the Couchbase client in your code:"
echo "     from couchbase_client import CouchbaseClient"
echo "  2. The initialization is handled automatically in src/backend/init/couchbase.py"
echo "  3. Add new collections using: ./bin/add-couchbase-collection <collection-name>"