instructions: |
  Working with Bluetext - A Polytope-based development framework.

  # PROJECT STRUCTURE

  This is a containerized full-stack application orchestrated by Polytope:
  - **Frontend services**: React + shadcn/ui + React Router v7 (modules/frontend or modules/<service-name>)
  - **API services**: FastAPI + SQLModel + uv for Python dependency management (modules/api or modules/<service-name>)
  - **Databases**: PostgreSQL, Couchbase (modules/postgres, modules/couchbase)
  - **Infrastructure**: All services run in containers with hot reload enabled
  - **Shared libraries**: Located in lib/ directory (lib/py/* for Python shared code)

  Each service is independently containerized with its own polytope.yml configuration and runs with hot reload enabled.

  # CRITICAL: ALWAYS RETRIEVE CONTEXT BEFORE MAKING CHANGES

  **MANDATORY FIRST STEP**: Before making ANY code changes, you MUST call `get-ai-dev-context` to retrieve development guidelines:

  1. Call `list-ai-dev-context-scopes` to see available context scopes
  2. Call `get-ai-dev-context(scope: <scope-name>)` for your specific task:
     - "general" - Project overview, environment variables, MCP tools
     - "api" - API routes, authentication, Temporal workflows, Couchbase models
     - "frontend" - Import paths, theming, shadcn components, routing
  3. Follow the retrieved guidelines during development to avoid breaking changes

  This context contains critical information about import paths, authentication patterns, database schemas, and more that will prevent errors.

  # TOOL USAGE PATTERNS

  1. **Before making changes**: Always list the steps that have been run to understand the current project state:
     ```mcp
     __polytope__list_steps()
     ```
     This ensures you have full context of what has been scaffolded and configured before starting to work with the project.

  2. **After adding services or functionality**: Always run __polytope__list_tools() after calling any tool that adds new services or functionality to existing services. This includes:
     - After add-frontend, add-api, add-postgres, add-couchbase, add-temporal
     - After adding client libraries (e.g., api-add-couchbase-client, api-add-temporal-client)
     - After any tool that modifies service capabilities

  3. **After code changes**: It is MANDATORY to check container logs whenever a service is modified through code changes:
     ```mcp
     __polytope__get_container_logs(container: <service-name>, limit: 25)
     ```
     **Important:** All running services have hot reload enabled. No manual restarts are necessary. Errors will surface when invalid code changes have been made. Always check for any import errors, syntax errors, or runtime exceptions after making code changes.


tools:
  add-frontend:
    info: |
      Creates and starts a frontend boilerplate subproject at the supplied path.
      Always use this when creating a new frontend project.
      The project uses bun+shadcn+react-router v7.
      Runs in a container running the subproject handled by Polytope.
      The environment is set to dev and hot reload is enabled.
      Defines an additional module for dependency management in the subprojects polytope.yml file.

      ⚠️ IMPORTANT: Before making changes to the frontend code, call get-ai-dev-context(scope: "frontend") to retrieve import paths, component patterns, and styling conventions.
    await: [scaffold-frontend]
    params:
      - id: service-name
        info: Name of the service to create and run at <project-root>/modules/<service-name>.
        type: [default, str, frontend]
    run:
      - id: scaffold-frontend
        tool: polytope/scaffold
        args:
          actions:
            - template: {type: repo, repo: "#pt-clj pt/module-repo-ref", path: frontend-react-router}
              path: modules/{pt.param service-name}
              add-to-tools: [{tool: default, call: pt.param service-name}]
      - id: frontend
        after: {step: scaffold-frontend}
        code: |-
          #pt-clj
          (-> (clojure.string/replace (:service-name params) #"[^A-Za-z0-9-]*$" "")
              (clojure.string/replace  #".*/" "")
              (pt/call-module {}))
  add-api:
    info: |
      Creates and starts an API boilerplate subproject.
      Always use this when creating a new API service.
      The project uses uv+FastAPI+SQLModel and has configuration options for Postgres, Couchbase and Temporal.
      Runs in a container handled by Polytope running the subproject.
      The environment is set to dev and hot reload is enabled.
      Defines an additional module for dependency management in the subprojects polytope.yml file.

      ⚠️ IMPORTANT: Before making changes to the API code, call get-ai-dev-context(scope: "api") to retrieve authentication patterns, route structure, database models, and import paths.
    await: [scaffold-api]
    params:
      - id: service-name
        info: Name of the service to create and run at <project-root>/modules/<service-name>.
        type: [default, str, api]
    run:
      - id: scaffold-api
        tool: polytope/scaffold
        args:
          actions:
            - template: {type: repo, repo: "#pt-clj pt/module-repo-ref", path: api}
              path: modules/{pt.param service-name}
              add-to-tools: [{tool: default, call: pt.param service-name}]
            - template: {type: repo, repo: "#pt-clj pt/module-repo-ref", path: lib/py/readme}
              path: lib/py/readme
              on-conflict: skip
      - id: api
        after: {step: scaffold-api}
        code: |-
          #pt-clj
          (-> (clojure.string/replace (:service-name params) #"[^A-Za-z0-9-]*$" "")
              (clojure.string/replace  #".*/" "")
              (pt/call-module {}))
  api-add-postgres-client:
    info: |
      Adds PostgreSQL client library with database support to an API service.
      Run this after add-postgres to enable database operations in your API.
    params:
      - id: service-name
        info: Name of the API service to add the client to
        type: [default, str, api]
    run:
      - tool: polytope/scaffold
        args:
          actions:
            - template: {type: repo, repo: "#pt-clj pt/module-repo-ref", path: lib/py/postgres-client}
              path: lib/py/postgres-client
              on-conflict: skip
      - id: run-script
        code: |
          #pt-clj
          (let [service-name (-> (:service-name params)
                                 (clojure.string/replace #"[^A-Za-z0-9-]*$" "")
                                 (clojure.string/replace #".*/" ""))
                tool-name (str service-name "-add-postgres-client")]
            (pt/call-tool tool-name {}))

  api-add-twilio-client:
    info: |
      Adds Twilio SMS client library to an API service.
      Enables SMS sending capabilities via Twilio's API.
    params:
      - id: service-name
        info: Name of the API service to add the client to
        type: [default, str, api]
    run:
      - tool: polytope/scaffold
        args:
          actions:
            - template: {type: repo, repo: "#pt-clj pt/module-repo-ref", path: lib/py/twilio-client}
              path: lib/py/twilio-client
              on-conflict: skip
      - id: run-script
        code: |
          #pt-clj
          (let [service-name (-> (:service-name params)
                                 (clojure.string/replace #"[^A-Za-z0-9-]*$" "")
                                 (clojure.string/replace #".*/" ""))
                tool-name (str service-name "-add-twilio-client")]
            (pt/call-tool tool-name {}))

  add-postgres:
    info: |
      Creates and starts a Postgres subproject under <project-root>/modules/postgres.
      Runs a Postgres server in a container handled by Polytope.
      The environment is set to run in a basic dev mode with no auth, etc.
    await: [scaffold-postgres]
    run:
      - id: scaffold-postgres
        tool: polytope/scaffold
        args:
          actions:
            - template: {type: repo, repo: "#pt-clj pt/module-repo-ref", path: postgres}
              path: modules/postgres
              on-conflict: skip
              add-to-tools: [{tool: default, call: postgres}]
      - id: postgres
        after: {step: scaffold-postgres}
        code: '#pt-clj (pt/call-module "postgres" {})'

  add-couchbase:
    info: |
      Creates and starts a Couchbase subproject under <project-root>/modules/couchbase.
      Runs a Couchbase server in a container handled by Polytope.
      Associated configuration files can be found at modules/config-manager/conf/.
      The environment is set to run in a basic dev mode with no auth, etc.
    await: [scaffold-couchbase, scaffold-config-manager]
    run:
      - id: scaffold-couchbase
        tool: polytope/scaffold
        args:
          actions:
            - template: {type: repo, repo: "#pt-clj pt/module-repo-ref", path: config-manager}
              path: modules/config-manager
              on-conflict: skip
              add-to-tools: [{tool: default, call: config-manager}]
            - template: {type: repo, repo: "#pt-clj pt/module-repo-ref", path: couchbase}
              path: modules/couchbase
              on-conflict: skip
              add-to-tools: [{tool: default, call: couchbase}]
      - id: config-manager
        after: {step: scaffold-couchbase}
        code: '#pt-clj (pt/call-module "config-manager" {})'
      - id: couchbase
        after: {step: scaffold-couchbase}
        code: '#pt-clj (pt/call-module "couchbase" {})'

  add-temporal:
    info: |
      Creates and starts a
        - Temporal subproject under <project-root>/modules/temporal.
        - Postgres subproject under <project-root>/modules/postgres if not already present.
        - Temporal UI subproject under <project-root>/modules/temporal-ui.
      Everything runs in containers handled by Polytope.
      The environment is set to run in a basic dev mode with no auth, etc.
    await: [scaffold-postgres, scaffold-temporal]
    run:
      - id: scaffold-temporal
        tool: polytope/scaffold
        args:
          actions:
            - template: {type: repo, repo: "#pt-clj pt/module-repo-ref", path: temporal}
              path: modules/temporal
              on-conflict: skip
              add-to-tools:
                - {tool: default, call: temporal}
                - {tool: default, call: temporal-ui}
            - template: {type: repo, repo: "#pt-clj pt/module-repo-ref", path: postgres}
              path: modules/postgres
              on-conflict: skip
              add-to-tools: [{tool: default, call: postgres}]
      - id: postgres
        after: {step: scaffold-temporal}
        code: '#pt-clj (pt/call-module "postgres" {})'
      - id: temporal
        after: {step: scaffold-temporal}
        code: '#pt-clj (pt/call-module "temporal" {})'
      - id: temporal-ui
        after: {step: scaffold-temporal}
        code: '#pt-clj (pt/call-module "temporal-ui" {})'

  list-ai-dev-context-scopes:
    info: Lists all available AI development context scopes.
    run:
      - tool: polytope/container
        args:
          image: alpine:latest
          cmd: sh -c "ls -1 /scopes | sed 's/\\.md$//'"
          mounts:
            - { path: /scopes, source: { type: repo, path: scopes } }

  get-ai-dev-context:
    info: |
      **CRITICAL**: Retrieves essential development guidelines and context for the current scope.
      ALWAYS call this tool BEFORE making code changes to understand project-specific patterns, import paths, authentication flows, and database schemas.
      This prevents breaking changes and ensures consistency with existing codebase patterns.
      Available scopes: general (overview), api (backend), frontend (UI). Call list-ai-dev-context-scopes to see all options.
    params:
      - id: scope
        info: "The scope to fetch (default: general)"
        type: [default, str, general]
    run:
      - tool: polytope/container
        args:
          image: alpine:latest
          cmd: cat /scopes/{pt.param scope}.md
          mounts:
            - { path: /scopes, source: { type: repo, path: scopes } }
