#!/usr/bin/env bash

# Generic script to populate Couchbase collections via the API
# Usage: populate-collection <bucket> <scope> <collection> <json_file>

set -e

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Default values
API_URL="${API_URL:-http://localhost:3030}"

# Function to display usage
usage() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS] <collection> <data_file>

Populate a Couchbase collection with data from a JSON file.

Arguments:
    collection      Name of the collection endpoint (e.g., 'cities')
    data_file       Path to JSON file containing array of documents to insert

Options:
    -u, --url URL          API base URL (default: http://localhost:3030)
    -b, --bucket BUCKET    Couchbase bucket name (informational)
    -s, --scope SCOPE      Couchbase scope name (informational)
    -h, --help             Display this help message

Environment Variables:
    API_URL               Override default API URL

Data File Format:
    The JSON file should contain an array of objects, where each object
    represents a document to insert. Each document should include all
    required fields for the collection.

    Example (cities.json):
    [
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "name": "Tokyo",
        "country": "Japan",
        "population": 37400068,
        "latitude": 35.6762,
        "longitude": 139.6503
      },
      ...
    ]

Examples:
    # Populate cities collection
    $(basename "$0") cities data/cities.json

    # Populate with custom API URL
    $(basename "$0") -u http://api.example.com users data/users.json

    # With full keyspace information
    $(basename "$0") -b main -s default -c cities data/cities.json

EOF
    exit 1
}

# Parse command line arguments
BUCKET=""
SCOPE=""
COLLECTION=""
DATA_FILE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -u|--url)
            API_URL="$2"
            shift 2
            ;;
        -b|--bucket)
            BUCKET="$2"
            shift 2
            ;;
        -s|--scope)
            SCOPE="$2"
            shift 2
            ;;
        -h|--help)
            usage
            ;;
        -*)
            echo -e "${RED}Error: Unknown option: $1${NC}" >&2
            usage
            ;;
        *)
            if [ -z "$COLLECTION" ]; then
                COLLECTION="$1"
            elif [ -z "$DATA_FILE" ]; then
                DATA_FILE="$1"
            else
                echo -e "${RED}Error: Too many arguments${NC}" >&2
                usage
            fi
            shift
            ;;
    esac
done

# Validate required arguments
if [ -z "$COLLECTION" ] || [ -z "$DATA_FILE" ]; then
    echo -e "${RED}Error: Missing required arguments${NC}" >&2
    usage
fi

# Check if data file exists
if [ ! -f "$DATA_FILE" ]; then
    echo -e "${RED}Error: Data file not found: $DATA_FILE${NC}" >&2
    exit 1
fi

# Display configuration
echo "=========================================="
echo "Couchbase Collection Population Script"
echo "=========================================="
echo "API URL:        $API_URL"
echo "Collection:     $COLLECTION"
if [ -n "$BUCKET" ]; then
    echo "Bucket:         $BUCKET"
fi
if [ -n "$SCOPE" ]; then
    echo "Scope:          $SCOPE"
fi
echo "Data File:      $DATA_FILE"
echo "=========================================="
echo ""

# Check if the API is reachable
echo -e "${YELLOW}Checking API connectivity...${NC}"
if ! curl -s -f -o /dev/null --max-time 5 "$API_URL/health"; then
    echo -e "${RED}Error: Cannot reach API at $API_URL${NC}" >&2
    echo "Please ensure the API server is running." >&2
    exit 1
fi
echo -e "${GREEN}✓ API is reachable${NC}"
echo ""

# Read and parse the JSON file
echo -e "${YELLOW}Reading data from $DATA_FILE...${NC}"

# Count total documents
TOTAL_DOCS=$(jq '. | length' "$DATA_FILE" 2>/dev/null)
if [ $? -ne 0 ]; then
    echo -e "${RED}Error: Invalid JSON format in $DATA_FILE${NC}" >&2
    exit 1
fi

echo -e "${GREEN}✓ Found $TOTAL_DOCS documents to insert${NC}"
echo ""

# Populate the collection
echo -e "${YELLOW}Populating collection '$COLLECTION'...${NC}"
echo ""

SUCCESS_COUNT=0
FAILURE_COUNT=0

# Process each document
jq -c '.[]' "$DATA_FILE" | while IFS= read -r doc; do
    # Extract the document name/id for logging
    DOC_NAME=$(echo "$doc" | jq -r '.name // .id // "unknown"' 2>/dev/null || echo "unknown")
    
    # Post the document
    HTTP_CODE=$(curl -s -o /tmp/response.txt -w "%{http_code}" \
        -X POST \
        -H "Content-Type: application/json" \
        -d "$doc" \
        "$API_URL/$COLLECTION")
    
    if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
        echo -e "${GREEN}✓ Added: $DOC_NAME${NC}"
        ((SUCCESS_COUNT++)) || true
    else
        echo -e "${RED}✗ Failed: $DOC_NAME (HTTP $HTTP_CODE)${NC}"
        if [ -f /tmp/response.txt ]; then
            echo "  Response: $(cat /tmp/response.txt)"
        fi
        ((FAILURE_COUNT++)) || true
    fi
done

# Cleanup
rm -f /tmp/response.txt

echo ""
echo "=========================================="
echo "Population Summary"
echo "=========================================="
echo "Total documents: $TOTAL_DOCS"
echo -e "${GREEN}Successful:      $SUCCESS_COUNT${NC}"
if [ "$FAILURE_COUNT" -gt 0 ]; then
    echo -e "${RED}Failed:          $FAILURE_COUNT${NC}"
fi
echo "=========================================="
echo ""

# Verify the results
echo -e "${YELLOW}Verifying collection contents...${NC}"
VERIFY_RESPONSE=$(curl -s "$API_URL/$COLLECTION")
VERIFY_COUNT=$(echo "$VERIFY_RESPONSE" | jq '. | length' 2>/dev/null || echo "0")

echo -e "${GREEN}✓ Collection '$COLLECTION' now contains $VERIFY_COUNT documents${NC}"

# Display sample of the data
echo ""
echo "Sample documents from collection:"
echo "$VERIFY_RESPONSE" | jq '.[:3]' 2>/dev/null || echo "$VERIFY_RESPONSE"

echo ""
echo -e "${GREEN}Population complete!${NC}"
